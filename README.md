This repository is used to document custom codes in Zhang lab to preprocess BICCN DART-FISH images. To run the custom codes, we install the required python packages in conda virtual environment, "DF_201012" and install SimpleElastix. 

# Create virtual environment and install required packages
Run these commands to build SimpleElastix in the DF_201012 environment.
```
mkdir ~/path/to/SimpleElastix_201012
cd ~/path/to/SimpleElastix_201012
mv DF201012.ymal ~/path/to/SimpleElastix_201012
```
Create and activate DF_201012 virtual environment
```
conda env create -f DF_201012_env.yml
conda activate DF_201012
```
Clone and build SimpleElastix
```
git clone https://github.com/SuperElastix/SimpleElastix
mkdir build
cd build
PYTHON_LIBRARY=~/anaconda3/envs/DF_201012/bin/python
cmake ../SimpleElastix/SuperBuild
make -j8
cd SimpleITK-build/Wrapping/Python
python Packaging/setup.py install --user
```
Download  FIJI and model weights for cellpose
Download FIJI from https://downloads.imagej.net/fiji/latest/fiji-latest-linux64-jdk.zip and unzip it.
Cellpose's weights can be downloaded using the function "download_model_weights" in cellpose.models.

# Set up the structure of directories
All data and codes to process DART-FISH images are kept in the same directory with the following structure of directories. 
## 0_Raw
0_Raw directory contails all tiff files from one DART-FISH experiments. The examples below shows the output tiff files from Leica SP8 microscope. Each tiff file is named after "round_name1"_s*_z*_ch*.tif format, where s is the field of view (FOV) number, z the number for z-stack, and ch the fluorescent channel.
## 1_Projected
1_Projected will contain all maximal intensity projected images.
## 2_Registered
2_Registered will contain images that are registered to images in the reference imaging cycle.
## 3_Decoded
3_Decoded will contiain tables that include spots decoded by SpaceTx StarFish
## 4_CellAssigment
4_CellAssigment will contain the segmentation mask by cellpose and cell-by-gene matrix.
## Codes
Codes directory contains all codes used to process DART-FISH images. The subfolder "code_lib" contains classes that are used during data processing while "_codebook" contains codebook encoding each gene. The codebook is generated by running "CodebookGenerator_201017.py". To generate a codebook successfully, we need a gene-barcode file that is located at "_codebook/TB12k_Mar2018_V7_noAnchor.txt". In addition, other important inputs are the length of the codewords and the number of off-cycles. The codebook will synthesized in .json format and will be saved in "_codebook/". It should contain all the empty barcodes that have two off cycles and are not uni-color. Should change directory to the "Codes" directory to run each python code step-by-step.
```
Experiment    
|___0_Raw
│   │___"Round_name1"
│   │       "round_name1"_s*_z*_ch00.tif
|   |       "round_name1"_s*_z*_ch01.tif
|   |       "round_name1"_s*_z*_ch02.tif
|   |       "round_name1"_s*_z*_ch03.tif
│   |        ...
|   |___"Round_name2"
│   │       "round_name1"_s*_z*_ch00.tif
|   |       "round_name1"_s*_z*_ch01.tif
|   |       "round_name1"_s*_z*_ch02.tif
|   |       "round_name1"_s*_z*_ch03.tif
│   |        ...
|___1_Projected
|   │___"FOV001"    
|   │       MIP_"round_name1"_FOV001_ch00.tif
|   |       MIP_"round_name1"_FOV001_ch01.tif
|   |       MIP_"round_name1"_FOV001_ch02.tif
|   |       MIP_"round_name1"_FOV001_ch03.tif
|   |       ...
|   |___"FOV002"
|   |       ...
|___2_Registered
|___3_Decoded
|___4_CellAssignment
|___Codes
|   |___"code_lib"
|   |___"_codebook"
```
# Maximal intensity projection and image registration

# Image stitching

# Starfish decoding

# Nucleus segmentation and assigment of decoded spots to nuclei

